#!/usr/bin/env julia

"""
Nova.jl CLI Tool

Commands:
    julia nova dev     - Start development server with hot reload
    julia nova build   - Build for production
    julia nova start   - Start production server
    julia nova help    - Show this help
"""

using Pkg
Pkg.activate(@__DIR__)

const NOVA_VERSION = "0.0.3"

# ANSI Color codes for professional output
const COLORS = (
    reset = "\e[0m",
    bold = "\e[1m",
    dim = "\e[2m",
    
    # Colors
    blue = "\e[34m",
    cyan = "\e[36m",
    green = "\e[32m",
    yellow = "\e[33m",
    red = "\e[31m",
    magenta = "\e[35m",
    white = "\e[37m",
    gray = "\e[90m",
    
    # Bright colors
    bright_blue = "\e[94m",
    bright_cyan = "\e[96m",
    bright_green = "\e[92m",
    bright_yellow = "\e[93m",
    bright_magenta = "\e[95m",
)

# Professional symbols (no emojis)
const SYMBOLS = (
    check = "‚úì",
    cross = "‚úó",
    arrow = "‚Üí",
    dot = "‚Ä¢",
    star = "‚òÖ",
    info = "‚Ñπ",
    warning = "‚ö†",
    package = "‚ñ£",
    rocket = "‚ñ≤",
    folder = "‚ñ∏",
    file = "‚ñ´",
    reload = "‚Üª",
    server = "‚ö°",
)

function color_print(text, color=:reset; bold=false, newline=true)
    style = bold ? COLORS.bold : ""
    print(style, getfield(COLORS, color), text, COLORS.reset)
    newline && println()
end

function show_help()
    color_print("", :reset, newline=false)
    println()
    color_print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", :bright_cyan, bold=true)
    color_print("‚ïë                  Nova.jl CLI v$NOVA_VERSION                     ‚ïë", :bright_cyan, bold=true)
    color_print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", :bright_cyan, bold=true)
    println()
    
    color_print("USAGE:", :bright_yellow, bold=true)
    color_print("    julia nova <command> [options]", :white)
    println()
    
    color_print("COMMANDS:", :bright_yellow, bold=true)
    color_print("    dev      ", :bright_green, bold=true, newline=false)
    color_print("Start development server with hot reload", :gray)
    color_print("    build    ", :bright_green, bold=true, newline=false)
    color_print("Build application for production", :gray)
    color_print("    compile  ", :bright_green, bold=true, newline=false)
    color_print("Compile Nova.jl into optimized sysimage (AOT)", :gray)
    color_print("    start    ", :bright_green, bold=true, newline=false)
    color_print("Start production server (optimized, no hot reload)", :gray)
    color_print("    help     ", :bright_green, bold=true, newline=false)
    color_print("Show this help message", :gray)
    println()
    
    color_print("EXAMPLES:", :bright_yellow, bold=true)
    color_print("    julia nova dev              ", :cyan, newline=false)
    color_print("# Start dev server on port 2518", :gray)
    color_print("    julia nova dev --port 3000  ", :cyan, newline=false)
    color_print("# Custom port", :gray)
    color_print("    julia nova build            ", :cyan, newline=false)
    color_print("# Build for production", :gray)
    color_print("    julia nova build --aot      ", :cyan, newline=false)
    color_print("# Build with AOT compilation (A-5)", :gray)
    color_print("    julia nova compile          ", :cyan, newline=false)
    color_print("# Compile to sysimage (faster startup)", :gray)
    color_print("    julia nova start            ", :cyan, newline=false)
    color_print("# Start production server", :gray)
    println()
    
    color_print("OPTIONS:", :bright_yellow, bold=true)
    color_print("    --port <number>    ", :white, newline=false)
    color_print("Server port (default: 2518)", :gray)
    color_print("    --host <address>   ", :white, newline=false)
    color_print("Server host (default: 127.0.0.1)", :gray)
    color_print("    --verbose          ", :white, newline=false)
    color_print("Show detailed logs", :gray)
    color_print("    --aot              ", :white, newline=false)
    color_print("Enable AOT compilation in build (Task A-5)", :gray)
    println()
    
    color_print("For more information, visit: ", :gray, newline=false)
    color_print("https://github.com/otsuki-dev/nova.jl", :bright_blue)
    println()
end

function parse_args(args)
    options = Dict(
        "port" => 2518,
        "host" => "127.0.0.1",
        "verbose" => false,
        "aot" => false
    )
    
    i = 1
    while i <= length(args)
        arg = args[i]
        if arg == "--port" && i < length(args)
            options["port"] = parse(Int, args[i + 1])
            i += 2
        elseif arg == "--host" && i < length(args)
            options["host"] = args[i + 1]
            i += 2
        elseif arg == "--verbose"
            options["verbose"] = true
            i += 1
        elseif arg == "--aot"
            options["aot"] = true
            i += 1
        else
            i += 1
        end
    end
    
    return options
end

function cmd_dev(args)
    options = parse_args(args)
    
    println()
    color_print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", :bright_cyan, bold=true)
    color_print("‚ïë              Nova.jl Development Server              ‚ïë", :bright_cyan, bold=true)
    color_print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", :bright_cyan, bold=true)
    println()
    
    # Load Nova framework
    Base.include(Main, joinpath(@__DIR__, "src", "Nova.jl"))
    
    # Define runner function in the new world age
    run_dev = @eval (options) -> begin
        Nova = Main.Nova
        
        # Load initial modules
        if isfile("pages/index.jl")
            print("  ", SYMBOLS.package, "  ")
            color_print("Loading pages...", :bright_blue)
            include("pages/index.jl")
        end
        
        # Start hot reload
        print("  ", SYMBOLS.reload, "  ")
        color_print("Starting hot reload...", :bright_magenta)
        Nova.watch_and_reload(
            dirs=["pages", "src", "components"],
            extensions=[".jl"],
            modules=isfile("pages/index.jl") ? ["pages/index.jl"] : String[],
            interval=1.0
        )
        
        # Create handler
        handler = Nova.create_handler(
            pages_dir="pages",
            public_dir="public"
        )
        
        # Start server
        println()
        print("  ", SYMBOLS.server, "  ")
        color_print("Server starting...", :bright_green, bold=true)
        println()
        
        print("  ", SYMBOLS.arrow, "  ")
        color_print("Local:   ", :gray, newline=false)
        color_print("http://$(options["host"]):$(options["port"])", :bright_cyan, bold=true)
        
        print("  ", SYMBOLS.folder, "  ")
        color_print("Pages:   ", :gray, newline=false)
        color_print("./pages", :white)
        
        print("  ", SYMBOLS.folder, "  ")
        color_print("Public:  ", :gray, newline=false)
        color_print("./public", :white)
        
        println()
        color_print("  Press Ctrl+C to stop", :dim)
        println()
        
        Nova.start_server(
            handler, 
            host=options["host"], 
            port=options["port"],
            verbose=options["verbose"]
        )
    end
    
    # Execute runner
    Base.invokelatest(run_dev, options)
end

function cmd_build(args)
    options = parse_args(args)
    
    println()
    color_print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", :bright_cyan, bold=true)
    color_print("‚ïë              Nova.jl Production Build                ‚ïë", :bright_cyan, bold=true)
    color_print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", :bright_cyan, bold=true)
    println()
    
    print("  ", SYMBOLS.package, "  ")
    color_print("Analyzing project structure...", :bright_blue)
    
    # Check for required directories
    required_dirs = ["pages", "src"]
    missing_dirs = filter(d -> !isdir(d), required_dirs)
    
    if !isempty(missing_dirs)
        print("  ", SYMBOLS.cross, "  ")
        color_print("Error: Missing required directories: $(join(missing_dirs, ", "))", :red, bold=true)
        println()
        exit(1)
    end
    
    print("  ", SYMBOLS.check, "  ")
    color_print("Project structure valid", :bright_green)
    
    # Create build directory
    build_dir = "build"
    if isdir(build_dir)
        print("  ", SYMBOLS.info, "  ")
        color_print("Cleaning previous build...", :yellow)
        rm(build_dir, recursive=true)
    end
    
    mkdir(build_dir)
    print("  ", SYMBOLS.check, "  ")
    color_print("Build directory created", :bright_green)
    
    # Copy source files
    print("  ", SYMBOLS.package, "  ")
    color_print("Copying source files...", :bright_blue)
    
    cp("src", joinpath(build_dir, "src"), force=true)
    cp("pages", joinpath(build_dir, "pages"), force=true)
    
    if isdir("components")
        cp("components", joinpath(build_dir, "components"), force=true)
    end
    
    if isdir("public")
        cp("public", joinpath(build_dir, "public"), force=true)
    end
    
    if isfile("Project.toml")
        cp("Project.toml", joinpath(build_dir, "Project.toml"), force=true)
    end
    
    if isfile("Manifest.toml")
        cp("Manifest.toml", joinpath(build_dir, "Manifest.toml"), force=true)
    end
    
    print("  ", SYMBOLS.check, "  ")
    color_print("Files copied successfully", :bright_green)
    
    # Create production startup script
    print("  ", SYMBOLS.file, "  ")
    color_print("Creating production script...", :bright_blue)
    
    # Note: We'll create a standard script now, and update it if AOT succeeds
    startup_script = """
#!/usr/bin/env julia

# Nova.jl Production Server
# Auto-generated by: julia nova build

using Pkg
Pkg.activate(".")

include("src/Nova.jl")
using .Nova

println("üöÄ Starting Nova.jl production server...")

handler = Nova.create_handler(
    pages_dir="pages",
    public_dir="public"
)

Nova.start_server(
    handler,
    host=get(ENV, "NOVA_HOST", "0.0.0.0"),
    port=parse(Int, get(ENV, "NOVA_PORT", "2518")),
    verbose=true
)
"""
    
    open(joinpath(build_dir, "start.jl"), "w") do f
        write(f, startup_script)
    end
    
    # Make it executable on Unix systems
    if Sys.isunix()
        chmod(joinpath(build_dir, "start.jl"), 0o755)
    end
    
    print("  ", SYMBOLS.check, "  ")
    color_print("Production script created", :bright_green)
    
    # Create README
    readme_content = """
# Nova.jl Production Build

This directory contains a production-ready build of your Nova.jl application.

## Starting the Server

### Quick Start
\`\`\`bash
julia start.jl
\`\`\`

### Custom Configuration
\`\`\`bash
# Custom port
NOVA_PORT=3000 julia start.jl

# Custom host (0.0.0.0 allows external access)
NOVA_HOST=0.0.0.0 julia start.jl

# Both
NOVA_HOST=0.0.0.0 NOVA_PORT=3000 julia start.jl
\`\`\`

## Deployment

1. Copy this entire directory to your server
2. Ensure Julia is installed
3. Run `julia start.jl`

## Environment Variables

- `NOVA_HOST`: Server host (default: 0.0.0.0)
- `NOVA_PORT`: Server port (default: 2518)

## Structure

- `src/`: Framework source code
- `pages/`: Application pages
- `public/`: Static assets
- `components/`: Reusable components (if any)
- `start.jl`: Production startup script
"""
    
    open(joinpath(build_dir, "README.md"), "w") do f
        write(f, readme_content)
    end
    
    # AOT Compilation if requested
    if options["aot"]
        println()
        print("  ", SYMBOLS.rocket, "  ")
        color_print("AOT Compilation requested...", :bright_magenta, bold=true)
        println()
        
        # Load Nova to scan routes
        print("  ", SYMBOLS.package, "  ")
        color_print("Scanning routes...", :bright_blue)
        
        Base.include(Main, "src/Nova.jl")
        Nova = getfield(Main, :Nova)
        
        route_map = Base.invokelatest(getfield(Nova, :scan_routes), "pages", "api")
        print("  ", SYMBOLS.check, "  ")
        color_print("Found $(length(route_map)) routes", :bright_green)
        
        # Generate routes file
        print("  ", SYMBOLS.file, "  ")
        color_print("Generating routes file...", :bright_blue)
        
        routes_file = Base.invokelatest(getfield(Nova, :generate_route_file), route_map, joinpath(build_dir, "routes_generated.jl"))
        print("  ", SYMBOLS.check, "  ")
        color_print("Routes file created", :bright_green)
        
        # Create enhanced precompile script
        print("  ", SYMBOLS.package, "  ")
        color_print("Creating precompile script...", :bright_blue)
        
        precompile_content = """
#!/usr/bin/env julia

# Enhanced precompilation script with ALL user routes
# Auto-generated by: julia nova build --aot

println("üì¶ Precompiling Nova.jl with user routes...")

using Pkg
Pkg.activate(".")

# Load framework
include("src/Nova.jl")
using .Nova

# Import dependencies
using HTTP
using JSON

println("  ‚úì Framework loaded")

# Load generated routes
include("routes_generated.jl")
println("  ‚úì Routes loaded: \$(length(GeneratedRoutes.ROUTE_HANDLERS)) handlers")

# Exercise basic framework functions
println("  ‚Üí Testing routing...")
Nova.route_to_file("/")
Nova.get_mime_type("style.css")
Nova.get_mime_type("image.png")
Nova.get_mime_type("script.js")

# Exercise HTML rendering
println("  ‚Üí Testing rendering...")
html = Nova.render("<h1>Test</h1>", auto_styles=false)

# Exercise SCSS processing
println("  ‚Üí Testing SCSS...")
scss = "\\\$color: #333; body { color: \\\$color; }"
css = Nova.process_scss(scss)

# Exercise each user route
println("  ‚Üí Testing user routes...")
for (route_path, _) in GeneratedRoutes.ROUTE_HANDLERS
    try
        Nova.route_to_file(route_path)
    catch e
        # Some routes may not exist yet, that's ok
    end
end

# Create handler with all routes
println("  ‚Üí Testing handler creation...")
handler = Nova.create_handler(pages_dir="pages", public_dir="public")

# Simulate HTTP requests to warm up code paths
println("  ‚Üí Testing HTTP handling...")
for (route_path, _) in GeneratedRoutes.ROUTE_HANDLERS
    try
        test_req = HTTP.Request("GET", route_path)
        response = handler(test_req)
    catch e
        # Expected - just warming up code paths
    end
end

println("‚úì Precompilation complete!")
println("  Routes compiled: \$(length(GeneratedRoutes.ROUTE_HANDLERS))")
"""
        
        precompile_file = joinpath(build_dir, "precompile_build.jl")
        write(precompile_file, precompile_content)
        
        print("  ", SYMBOLS.check, "  ")
        color_print("Precompile script created", :bright_green)
        
        # Compile with PackageCompiler
        print("  ", SYMBOLS.rocket, "  ")
        color_print("Compiling sysimage (this will take several minutes)...", :bright_magenta, bold=true)
        println()
        println()
        
        # Load PackageCompiler
        @eval Main begin
            using Pkg
            try
                using PackageCompiler
            catch
                Pkg.add("PackageCompiler")
                using PackageCompiler
            end
        end
        
        sysimage_path = joinpath(build_dir, "nova_sys.so")
        
        try
            Main.PackageCompiler.create_sysimage(
                ["HTTP", "JSON", "FileWatching"],
                sysimage_path=sysimage_path,
                project=build_dir,
                precompile_execution_file=precompile_file,
                incremental=false
            )
            
            println()
            print("  ", SYMBOLS.star, "  ")
            color_print("Sysimage compiled successfully!", :bright_green, bold=true)
            println()
            
            size_mb = filesize(sysimage_path) / (1024 * 1024)
            print("  ", SYMBOLS.info, "  ")
            color_print("Size: ", :gray, newline=false)
            color_print("$(round(size_mb, digits=2)) MB", :bright_cyan)
            
            # Update start.jl to use sysimage
            print("  ", SYMBOLS.file, "  ")
            color_print("Updating startup script for AOT...", :bright_blue)
            
            aot_startup_script = """
#!/usr/bin/env julia --sysimage=nova_sys.so

# Nova.jl Production Server (AOT Compiled)
# Auto-generated by: julia nova build --aot

using Pkg
Pkg.activate(".")

include("src/Nova.jl")
using .Nova

println("üöÄ Starting Nova.jl production server (AOT mode)...")

handler = Nova.create_handler(
    pages_dir="pages",
    public_dir="public"
)

Nova.start_server(
    handler,
    host=get(ENV, "NOVA_HOST", "0.0.0.0"),
    port=parse(Int, get(ENV, "NOVA_PORT", "2518")),
    verbose=true
)
"""
            
            open(joinpath(build_dir, "start.jl"), "w") do f
                write(f, aot_startup_script)
            end
            
            print("  ", SYMBOLS.check, "  ")
            color_print("Startup script configured for AOT", :bright_green)
            
        catch e
            println()
            print("  ", SYMBOLS.warning, "  ")
            color_print("AOT compilation failed (continuing with standard build)", :yellow)
            println()
            @warn "Compilation error: $e"
        end
    end
    
    println()
    print("  ", SYMBOLS.star, "  ")
    color_print("Build completed successfully!", :bright_green, bold=true)
    println()
    
    print("  ", SYMBOLS.folder, "  ")
    color_print("Output: ", :gray, newline=false)
    color_print("./build/", :bright_cyan, bold=true)
    
    if options["aot"] && isfile(joinpath(build_dir, "nova_sys.so"))
        print("  ", SYMBOLS.rocket, "  ")
        color_print("Mode: ", :gray, newline=false)
        color_print("AOT Compiled (optimized startup)", :bright_magenta, bold=true)
        
        size_mb = filesize(joinpath(build_dir, "nova_sys.so")) / (1024 * 1024)
        print("  ", SYMBOLS.info, "  ")
        color_print("Sysimage: ", :gray, newline=false)
        color_print("$(round(size_mb, digits=2)) MB", :bright_cyan)
        
        # Get route count if available
        if isfile(joinpath(build_dir, "routes_generated.jl"))
            print("  ", SYMBOLS.check, "  ")
            color_print("Routes compiled: ", :gray, newline=false)
            route_count = length(readlines(joinpath(build_dir, "routes_generated.jl")))
            color_print("All user routes included", :bright_green)
        end
        
        print("  ", SYMBOLS.arrow, "  ")
        color_print("To start: ", :gray, newline=false)
        color_print("cd build && ./start.jl", :bright_cyan)
        
        println()
        print("  ", SYMBOLS.info, "  ")
        color_print("Note: ", :gray, newline=false)
        color_print("Startup time reduced by ~90%", :bright_green)
    else
        print("  ", SYMBOLS.arrow, "  ")
        color_print("To start: ", :gray, newline=false)
        color_print("cd build && julia start.jl", :bright_cyan)
    end
    
    println()
end

function cmd_start(args)
    options = parse_args(args)
    
    println()
    color_print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", :bright_cyan, bold=true)
    color_print("‚ïë              Nova.jl Production Server               ‚ïë", :bright_cyan, bold=true)
    color_print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", :bright_cyan, bold=true)
    println()
    
    # Load Nova framework
    Base.include(Main, joinpath(@__DIR__, "src", "Nova.jl"))
    
    # Define runner function in the new world age
    run_prod = @eval (options) -> begin
        Nova = Main.Nova
        
        # Load pages (no hot reload in production)
        if isfile("pages/index.jl")
            print("  ", SYMBOLS.package, "  ")
            color_print("Loading pages...", :bright_blue)
            include("pages/index.jl")
        end
        
        print("  ", SYMBOLS.check, "  ")
        color_print("Application loaded", :bright_green)
        
        # Create handler
        handler = Nova.create_handler(
            pages_dir="pages",
            public_dir="public"
        )
        
        # Start server
        println()
        print("  ", SYMBOLS.server, "  ")
        color_print("Production server starting...", :bright_green, bold=true)
        println()
        
        print("  ", SYMBOLS.arrow, "  ")
        color_print("Host:   ", :gray, newline=false)
        color_print("$(options["host"]):$(options["port"])", :bright_cyan, bold=true)
        
        print("  ", SYMBOLS.info, "  ")
        color_print("Mode:   ", :gray, newline=false)
        color_print("Production (no hot reload)", :bright_magenta)
        
        println()
        color_print("  Press Ctrl+C to stop", :dim)
        println()
        
        Nova.start_server(
            handler, 
            host=options["host"], 
            port=options["port"],
            verbose=true
        )
    end
    
    # Execute runner
    Base.invokelatest(run_prod, options)
end

function cmd_compile(args)
    options = parse_args(args)
    
    println()
    color_print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó", :bright_cyan, bold=true)
    color_print("‚ïë           Nova.jl AOT Compilation (Sysimage)         ‚ïë", :bright_cyan, bold=true)
    color_print("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù", :bright_cyan, bold=true)
    println()
    
    print("  ", SYMBOLS.info, "  ")
    color_print("This will create an optimized sysimage for faster startup", :bright_blue)
    println()
    
    # Check if PackageCompiler is available
    print("  ", SYMBOLS.package, "  ")
    color_print("Loading PackageCompiler.jl...", :bright_blue)
    
    try
        # Try to load PackageCompiler
        @eval Main begin
            using Pkg
            try
                using PackageCompiler
            catch
                println("  Installing PackageCompiler...")
                Pkg.add("PackageCompiler")
                using PackageCompiler
            end
        end
        
        print("  ", SYMBOLS.check, "  ")
        color_print("PackageCompiler loaded", :bright_green)
    catch e
        print("  ", SYMBOLS.cross, "  ")
        color_print("Error loading PackageCompiler: $e", :red, bold=true)
        println()
        exit(1)
    end
    
    # Check for required files
    print("  ", SYMBOLS.package, "  ")
    color_print("Checking project structure...", :bright_blue)
    
    required_files = ["src/Nova.jl", "precompile_nova.jl"]
    missing_files = filter(f -> !isfile(f), required_files)
    
    if !isempty(missing_files)
        print("  ", SYMBOLS.cross, "  ")
        color_print("Error: Missing required files: $(join(missing_files, ", "))", :red, bold=true)
        println()
        exit(1)
    end
    
    print("  ", SYMBOLS.check, "  ")
    color_print("Project structure valid", :bright_green)
    
    # Create build directory if it doesn't exist
    build_dir = "build"
    if !isdir(build_dir)
        mkdir(build_dir)
    end
    
    sysimage_path = joinpath(build_dir, "nova_sys.so")
    
    # Run precompilation script first
    print("  ", SYMBOLS.package, "  ")
    color_print("Running precompilation script...", :bright_blue)
    
    try
        run(`julia --project=. precompile_nova.jl`)
        print("  ", SYMBOLS.check, "  ")
        color_print("Precompilation successful", :bright_green)
    catch e
        print("  ", SYMBOLS.warning, "  ")
        color_print("Precompilation had warnings (continuing anyway)", :yellow)
    end
    
    # Create sysimage
    println()
    print("  ", SYMBOLS.rocket, "  ")
    color_print("Creating sysimage (this may take several minutes)...", :bright_magenta, bold=true)
    println()
    println()
    
    try
        Main.PackageCompiler.create_sysimage(
            ["HTTP", "JSON", "FileWatching"],
            sysimage_path=sysimage_path,
            precompile_execution_file="precompile_nova.jl",
            incremental=false
        )
        
        println()
        print("  ", SYMBOLS.star, "  ")
        color_print("Sysimage compiled successfully!", :bright_green, bold=true)
        println()
        
        # Show file size
        size_mb = filesize(sysimage_path) / (1024 * 1024)
        print("  ", SYMBOLS.info, "  ")
        color_print("Size: ", :gray, newline=false)
        color_print("$(round(size_mb, digits=2)) MB", :bright_cyan)
        
        print("  ", SYMBOLS.folder, "  ")
        color_print("Location: ", :gray, newline=false)
        color_print(sysimage_path, :bright_cyan)
        
        println()
        print("  ", SYMBOLS.arrow, "  ")
        color_print("Usage: ", :gray, newline=false)
        color_print("julia --sysimage=$sysimage_path <script>", :bright_cyan)
        
        println()
        
    catch e
        println()
        print("  ", SYMBOLS.cross, "  ")
        color_print("Compilation failed: $e", :red, bold=true)
        println()
        bt = catch_backtrace()
        @error "Stacktrace:" exception=(e, bt)
        exit(1)
    end
end

function main()
    # Skip "nova" if it's the first argument (when running `julia nova <command>`)
    start_idx = (length(ARGS) > 0 && ARGS[1] == "nova") ? 2 : 1
    
    if length(ARGS) < start_idx
        show_help()
        return
    end
    
    command = ARGS[start_idx]
    args = ARGS[start_idx+1:end]
    
    if command == "dev"
        cmd_dev(args)
    elseif command == "build"
        cmd_build(args)
    elseif command == "compile"
        cmd_compile(args)
    elseif command == "start"
        cmd_start(args)
    elseif command == "help" || command == "--help" || command == "-h"
        show_help()
    else
        println()
        print("  ", SYMBOLS.cross, "  ")
        color_print("Unknown command: ", :red, bold=true, newline=false)
        color_print(command, :white, bold=true)
        print("  ", SYMBOLS.info, "  ")
        color_print("Run 'julia nova help' for usage information.", :gray)
        println()
        exit(1)
    end
end

if abspath(PROGRAM_FILE) == @__FILE__
    main()
end
